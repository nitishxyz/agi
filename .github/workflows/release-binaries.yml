name: Build and Release CLI

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  check-publish-flag:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Check publish flag
        id: check
        shell: bash
        run: |
          if [ -f publish.env ]; then
            source publish.env
            echo "should_publish=${PUBLISH_CLI}" >> "$GITHUB_OUTPUT"
            echo "PUBLISH_CLI=${PUBLISH_CLI}"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "publish.env not found"
          fi

  check-version:
    needs: check-publish-flag
    if: needs.check-publish-flag.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Determine release version (bump if needed)
        id: determine_version
        shell: bash
        run: |
          set -euo pipefail
          CURRENT_VERSION=$(jq -r .version packages/install/package.json)
          if git rev-parse "v${CURRENT_VERSION}" >/dev/null 2>&1; then
            echo "Current tag v${CURRENT_VERSION} exists; bumping patch version"
            MAJOR=$(echo "$CURRENT_VERSION" | awk -F. '{print $1}')
            MINOR=$(echo "$CURRENT_VERSION" | awk -F. '{print $2}')
            PATCH=$(echo "$CURRENT_VERSION" | awk -F. '{print $3}')
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

            for pkg in package.json apps/cli/package.json packages/install/package.json packages/api/package.json packages/sdk/package.json packages/web-ui/package.json packages/web-sdk/package.json packages/database/package.json packages/server/package.json; do
              tmpfile=$(mktemp)
              jq ".version = \"${NEW_VERSION}\"" "$pkg" > "$tmpfile"
              mv "$tmpfile" "$pkg"
            done

            bun lint --fix || true

            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"

            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push origin "$BRANCH"
            echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"
            echo "Tag v${CURRENT_VERSION} does not exist; using it for this release"
          fi

  build-binaries:
    needs: check-version
    runs-on: ${{ matrix.runner }}
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    strategy:
      matrix:
        include:
          - os: darwin
            arch: x64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          - os: linux
            arch: x64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync to latest branch tip
        shell: bash
        run: |
          git fetch origin
          git checkout "${{ github.ref_name }}"
          git pull --ff-only origin "${{ github.ref_name }}"

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Regenerate clean lockfile
        shell: bash
        run: |
          rm -f bun.lock
          bun install

      - name: Setup npm auth (optional)
        if: ${{ env.NPM_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > .npmrc
          echo "always-auth=true" >> .npmrc

      - name: Install dependencies
        run: bun install

      - name: Build binary
        shell: bash
        run: |
          set -euo pipefail
          cd apps/cli
          mkdir -p dist
          case "${{ matrix.os }}-${{ matrix.arch }}" in
            darwin-arm64) bun run build:darwin-arm64 ;;
            darwin-x64) bun run build:darwin-x64 ;;
            linux-x64) bun run build:linux-x64 ;;
            linux-arm64) bun run build:linux-arm64 ;;
          esac

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: agi-${{ matrix.os }}-${{ matrix.arch }}
          path: apps/cli/dist/agi-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}

  publish:
    needs: [check-version, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Flatten artifacts
        run: |
          mkdir -p ./release
          find ./artifacts -type f -exec cp {} ./release/ \;
          ls -la ./release/

      - name: Create and push git tag
        shell: bash
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git fetch origin
          git checkout "${{ github.ref_name }}"
          git pull --ff-only origin "${{ github.ref_name }}"
          git tag "v${VERSION}"
          git push origin "v${VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: "AGI v${{ needs.check-version.outputs.version }}"
          body: |
            ## AGI v${{ needs.check-version.outputs.version }}

            Platform binaries are attached below.

            - macOS (Intel): agi-darwin-x64
            - macOS (Apple Silicon): agi-darwin-arm64
            - Linux (x64): agi-linux-x64
            - Linux (ARM64): agi-linux-arm64
          files: ./release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    needs: [check-version, publish]
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest branch tip
        shell: bash
        run: |
          git fetch origin
          git checkout "${{ github.ref_name }}"
          git pull --ff-only origin "${{ github.ref_name }}"

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Replace workspace dependencies
        shell: bash
        run: bun run scripts/prepare-publish.ts

      - name: Regenerate clean lockfile
        shell: bash
        run: |
          rm -f bun.lock
          bun install

      - name: Configure npm auth
        if: ${{ env.NPM_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > .npmrc
          echo "always-auth=true" >> .npmrc

      - name: Verify publish token present
        shell: bash
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "NPM_TOKEN is not set; skipping npm publish" >&2
            exit 1
          fi

      - name: Verify versions match
        shell: bash
        run: |
          INSTALL_VERSION=$(jq -r .version packages/install/package.json)
          for pkg in packages/api packages/sdk packages/web-ui packages/web-sdk packages/database packages/server; do
            PKG_VERSION=$(jq -r .version "$pkg/package.json")
            PKG_NAME=$(basename "$pkg")
            if [ "${INSTALL_VERSION}" != "${PKG_VERSION}" ]; then
              echo "Install version (${INSTALL_VERSION}) does not match ${PKG_NAME} version (${PKG_VERSION})" >&2
              exit 1
            fi
          done
          echo "âœ“ All packages version: ${INSTALL_VERSION}"

      - name: Publish all packages to npm
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.check-version.outputs.version }}"
          for pkg in packages/install packages/api packages/sdk packages/web-sdk packages/web-ui packages/database packages/server; do
            PKG_NAME=$(jq -r .name "$pkg/package.json")
            echo "Publishing ${PKG_NAME}@${VERSION} to npm..."
            cd "$pkg"
            bun publish --access public --tag latest
            cd "$GITHUB_WORKSPACE"
          done

  reset-flag:
    needs: [publish-npm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest branch tip
        shell: bash
        run: |
          git fetch origin
          git checkout "${{ github.ref_name }}"
          git pull --ff-only origin "${{ github.ref_name }}"

      - name: Reset PUBLISH_CLI flag
        shell: bash
        run: |
          sed -i 's/^PUBLISH_CLI=true$/PUBLISH_CLI=false/' publish.env
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add publish.env
          git commit -m "chore: reset PUBLISH_CLI flag [skip ci]" || echo "No changes to commit"
          git push origin "${{ github.ref_name }}"
