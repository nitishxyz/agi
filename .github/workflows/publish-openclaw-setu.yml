name: Publish @ottocode/openclaw-setu

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check publish flag
        id: check
        run: |
          if [ -f publish.env ]; then
            source publish.env
            echo "publish=${PUBLISH_OPENCLAW_SETU:-false}" >> "$GITHUB_OUTPUT"
          else
            echo "publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Bun
        if: steps.check.outputs.publish == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check.outputs.publish == 'true'
        run: bun install --frozen-lockfile

      - name: Type check
        if: steps.check.outputs.publish == 'true'
        run: bunx tsc --noEmit -p packages/openclaw-setu/tsconfig.json

      - name: Configure npm auth
        if: steps.check.outputs.publish == 'true'
        shell: bash
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > .npmrc
          echo "always-auth=true" >> .npmrc

      - name: Verify publish token
        if: steps.check.outputs.publish == 'true'
        shell: bash
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "NPM_TOKEN is not set; skipping npm publish" >&2
            exit 1
          fi

      - name: Check if version already published
        if: steps.check.outputs.publish == 'true'
        id: version
        run: |
          CURRENT=$(jq -r '.version' packages/openclaw-setu/package.json)
          PUBLISHED=$(npm view @ottocode/openclaw-setu version 2>/dev/null || echo "0.0.0")
          echo "current=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "published=${PUBLISHED}" >> "$GITHUB_OUTPUT"
          if [ "$CURRENT" = "$PUBLISHED" ]; then
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            PATCH=$((PATCH + 1))
            NEXT="${MAJOR}.${MINOR}.${PATCH}"
            echo "next=${NEXT}" >> "$GITHUB_OUTPUT"
            echo "bump=true" >> "$GITHUB_OUTPUT"
          else
            echo "next=${CURRENT}" >> "$GITHUB_OUTPUT"
            echo "bump=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version
        if: steps.check.outputs.publish == 'true' && steps.version.outputs.bump == 'true'
        run: |
          cd packages/openclaw-setu
          jq --arg v "${{ steps.version.outputs.next }}" '.version = $v' package.json > package.json.tmp
          mv package.json.tmp package.json

      - name: Publish to npm
        if: steps.check.outputs.publish == 'true'
        run: |
          cd packages/openclaw-setu
          npm publish --access public

      - name: Reset publish flag and commit
        if: steps.check.outputs.publish == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          sed -i 's/PUBLISH_OPENCLAW_SETU=true/PUBLISH_OPENCLAW_SETU=false/' publish.env
          git add publish.env packages/openclaw-setu/package.json
          NEXT="${{ steps.version.outputs.next }}"
          git commit -m "chore: release @ottocode/openclaw-setu v${NEXT}" -m "[skip ci]"
          git push
