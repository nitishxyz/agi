name: Test Build

on:
  workflow_dispatch:
    inputs:
      build_cli:
        description: "Build CLI binaries"
        type: boolean
        default: true
      build_desktop:
        description: "Build Desktop app"
        type: boolean
        default: false
      build_launcher:
        description: "Build Launcher app"
        type: boolean
        default: false
      platform_macos:
        description: "macOS"
        type: boolean
        default: true
      platform_linux:
        description: "Linux"
        type: boolean
        default: true
      platform_windows:
        description: "Windows"
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test-build-cli:
    if: inputs.build_cli
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: darwin
            arch: x64
            runner: macos-latest
            enabled: ${{ inputs.platform_macos }}
          - os: darwin
            arch: arm64
            runner: macos-latest
            enabled: ${{ inputs.platform_macos }}
          - os: linux
            arch: x64
            runner: ubuntu-latest
            enabled: ${{ inputs.platform_linux }}
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            enabled: ${{ inputs.platform_linux }}
          - os: windows
            arch: x64
            runner: windows-latest
            enabled: ${{ inputs.platform_windows }}
    steps:
      - name: Skip if platform disabled
        if: matrix.enabled != true
        run: echo "Skipping ${{ matrix.os }}-${{ matrix.arch }}"

      - uses: actions/checkout@v4
        if: matrix.enabled

      - uses: oven-sh/setup-bun@v1
        if: matrix.enabled
        with:
          bun-version: latest

      - name: Install dependencies
        if: matrix.enabled
        run: bun install

      - name: Download ripgrep binary
        if: matrix.enabled
        shell: bash
        run: |
          set -euo pipefail
          RIPGREP_VERSION="14.1.1"
          PLATFORM="${{ matrix.os }}-${{ matrix.arch }}"
          case "$PLATFORM" in
            darwin-arm64) RG_TARGET="aarch64-apple-darwin" ;;
            darwin-x64)   RG_TARGET="x86_64-apple-darwin" ;;
            linux-x64)    RG_TARGET="x86_64-unknown-linux-musl" ;;
            linux-arm64)  RG_TARGET="aarch64-unknown-linux-gnu" ;;
            windows-x64)  RG_TARGET="x86_64-pc-windows-msvc" ;;
            *) echo "Unknown platform: $PLATFORM"; exit 1 ;;
          esac
          VENDOR_DST="vendor/bin/${PLATFORM}"
          mkdir -p "$VENDOR_DST"
          ARCHIVE="ripgrep-${RIPGREP_VERSION}-${RG_TARGET}"
          if [[ "$PLATFORM" == windows-* ]]; then
            URL="https://github.com/BurntSushi/ripgrep/releases/download/${RIPGREP_VERSION}/${ARCHIVE}.zip"
            curl -fsSL "$URL" -o /tmp/rg.zip
            unzip -q /tmp/rg.zip -d /tmp
            cp "/tmp/${ARCHIVE}/rg.exe" "$VENDOR_DST/rg.exe"
          else
            URL="https://github.com/BurntSushi/ripgrep/releases/download/${RIPGREP_VERSION}/${ARCHIVE}.tar.gz"
            curl -fsSL "$URL" | tar -xz -C /tmp
            cp "/tmp/${ARCHIVE}/rg" "$VENDOR_DST/rg"
            chmod +x "$VENDOR_DST/rg"
          fi

      - name: Build CLI binary
        if: matrix.enabled
        shell: bash
        run: |
          set -euo pipefail
          cd apps/cli
          bun run ../../scripts/build-web.ts
          bun run ../../scripts/prepare-embedded-bins.ts "${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p dist
          EXT=""
          if [[ "${{ matrix.os }}" == "windows" ]]; then EXT=".exe"; fi
          bun build --compile --minify --target="bun-${{ matrix.os }}-${{ matrix.arch }}" ./index.ts --outfile "dist/otto-${{ matrix.os }}-${{ matrix.arch }}${EXT}"
          ls -la dist/

      - name: Upload artifact
        if: matrix.enabled
        uses: actions/upload-artifact@v4
        with:
          name: test-otto-${{ matrix.os }}-${{ matrix.arch }}
          path: apps/cli/dist/otto-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}

  test-build-desktop:
    if: inputs.build_desktop
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS-arm64
            cli_platform: darwin-arm64
            enabled: ${{ inputs.platform_macos }}
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS-x64
            cli_platform: darwin-x64
            enabled: ${{ inputs.platform_macos }}
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux-x64
            cli_platform: linux-x64
            enabled: ${{ inputs.platform_linux }}
          - platform: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            name: Linux-arm64
            cli_platform: linux-arm64
            enabled: ${{ inputs.platform_linux }}
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows-x64
            cli_platform: windows-x64
            enabled: ${{ inputs.platform_windows }}
    steps:
      - name: Skip if platform disabled
        if: matrix.enabled != true
        run: echo "Skipping ${{ matrix.name }}"

      - uses: actions/checkout@v4
        if: matrix.enabled

      - uses: oven-sh/setup-bun@v1
        if: matrix.enabled
        with:
          bun-version: latest

      - name: Setup Rust
        if: matrix.enabled
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.enabled && startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libfuse2

      - name: Install dependencies
        if: matrix.enabled
        run: bun install

      - name: Download ripgrep binary
        if: matrix.enabled
        shell: bash
        run: |
          set -euo pipefail
          RIPGREP_VERSION="14.1.1"
          PLATFORM="${{ matrix.cli_platform }}"
          case "${{ matrix.target }}" in
            aarch64-apple-darwin)  RG_TARGET="aarch64-apple-darwin" ;;
            x86_64-apple-darwin)   RG_TARGET="x86_64-apple-darwin" ;;
            x86_64-unknown-linux-gnu)  RG_TARGET="x86_64-unknown-linux-musl" ;;
            aarch64-unknown-linux-gnu) RG_TARGET="aarch64-unknown-linux-gnu" ;;
            x86_64-pc-windows-msvc)    RG_TARGET="x86_64-pc-windows-msvc" ;;
            *) echo "Unknown target: ${{ matrix.target }}"; exit 1 ;;
          esac
          VENDOR_DST="vendor/bin/${PLATFORM}"
          mkdir -p "$VENDOR_DST"
          ARCHIVE="ripgrep-${RIPGREP_VERSION}-${RG_TARGET}"
          if [[ "$PLATFORM" == windows-* ]]; then
            URL="https://github.com/BurntSushi/ripgrep/releases/download/${RIPGREP_VERSION}/${ARCHIVE}.zip"
            curl -fsSL "$URL" -o /tmp/rg.zip
            unzip -q /tmp/rg.zip -d /tmp
            cp "/tmp/${ARCHIVE}/rg.exe" "$VENDOR_DST/rg.exe"
          else
            URL="https://github.com/BurntSushi/ripgrep/releases/download/${RIPGREP_VERSION}/${ARCHIVE}.tar.gz"
            curl -fsSL "$URL" | tar -xz -C /tmp
            cp "/tmp/${ARCHIVE}/rg" "$VENDOR_DST/rg"
            chmod +x "$VENDOR_DST/rg"
          fi

      - name: Build CLI binary for desktop
        if: matrix.enabled
        shell: bash
        run: |
          set -euo pipefail
          PLATFORM="${{ matrix.cli_platform }}"
          EXT=""
          if [[ "$PLATFORM" == windows-* ]]; then EXT=".exe"; fi
          cd apps/cli
          bun run ../../scripts/build-web.ts
          bun run ../../scripts/prepare-embedded-bins.ts "${PLATFORM}"
          mkdir -p dist
          bun build --compile --minify --target="bun-${PLATFORM}" ./index.ts --outfile "dist/otto-${PLATFORM}${EXT}"
          mkdir -p ../desktop/src-tauri/resources/binaries
          cp "dist/otto-${PLATFORM}${EXT}" "../desktop/src-tauri/resources/binaries/otto-${PLATFORM}${EXT}"
          if [[ "$PLATFORM" != windows-* ]]; then
            chmod +x "../desktop/src-tauri/resources/binaries/otto-${PLATFORM}"
          fi

      - name: Import Apple Certificate
        if: matrix.enabled && startsWith(matrix.platform, 'macos')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No Apple certificate provided, skipping signing"
            exit 0
          fi
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERTIFICATE_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Sign bundled CLI binary
        if: matrix.enabled && startsWith(matrix.platform, 'macos')
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          for bin in apps/desktop/src-tauri/resources/binaries/*; do
            if [ -f "$bin" ]; then
              echo "Signing $bin with hardened runtime..."
              codesign --force --options runtime --timestamp \
                --sign "$APPLE_SIGNING_IDENTITY" \
                --entitlements apps/desktop/src-tauri/resources/entitlements.plist \
                "$bin"
            fi
          done

      - name: Build Tauri App
        if: matrix.enabled
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 2
          retry_wait_seconds: 30
          shell: bash
          command: |
            if [[ "${{ matrix.target }}" == *"linux"* ]]; then
              cd apps/desktop && npm run tauri build -- --target ${{ matrix.target }} --bundles deb
            elif [[ "${{ matrix.target }}" == *"windows"* ]]; then
              cd apps/desktop && npm run tauri build -- --target ${{ matrix.target }} --bundles msi,nsis
            else
              cd apps/desktop && npm run tauri build -- --target ${{ matrix.target }}
            fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: true

      - name: Upload artifacts
        if: matrix.enabled
        uses: actions/upload-artifact@v4
        with:
          name: test-desktop-${{ matrix.name }}
          path: |
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          if-no-files-found: ignore

  test-build-launcher:
    if: inputs.build_launcher
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS-arm64
            enabled: ${{ inputs.platform_macos }}
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS-x64
            enabled: ${{ inputs.platform_macos }}
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux-x64
            enabled: ${{ inputs.platform_linux }}
          - platform: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            name: Linux-arm64
            enabled: ${{ inputs.platform_linux }}
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows-x64
            enabled: ${{ inputs.platform_windows }}
    steps:
      - name: Skip if platform disabled
        if: matrix.enabled != true
        run: echo "Skipping ${{ matrix.name }}"

      - uses: actions/checkout@v4
        if: matrix.enabled

      - uses: oven-sh/setup-bun@v1
        if: matrix.enabled
        with:
          bun-version: latest

      - name: Setup Rust
        if: matrix.enabled
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.enabled && startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libfuse2

      - name: Install dependencies
        if: matrix.enabled
        run: bun install

      - name: Import Apple Certificate
        if: matrix.enabled && startsWith(matrix.platform, 'macos')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No Apple certificate provided, skipping signing"
            exit 0
          fi
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERTIFICATE_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Build Tauri Launcher App
        if: matrix.enabled
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 2
          retry_wait_seconds: 30
          shell: bash
          command: |
            if [[ "${{ matrix.target }}" == *"linux"* ]]; then
              cd apps/launcher && npm run tauri build -- --target ${{ matrix.target }} --bundles deb
            elif [[ "${{ matrix.target }}" == *"windows"* ]]; then
              cd apps/launcher && npm run tauri build -- --target ${{ matrix.target }} --bundles msi,nsis
            else
              cd apps/launcher && npm run tauri build -- --target ${{ matrix.target }}
            fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: true

      - name: Upload artifacts
        if: matrix.enabled
        uses: actions/upload-artifact@v4
        with:
          name: test-launcher-${{ matrix.name }}
          path: |
            apps/launcher/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            apps/launcher/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            apps/launcher/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            apps/launcher/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            apps/launcher/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          if-no-files-found: ignore
