Apply a patch to modify one or more files.

Use the **enveloped format** by default. Standard unified diffs (`---` / `+++`) are also accepted.

## Fastest / safest mode (recommended): Replace

Use this when exact `+/-/context` hunks are hard to build.

```text
*** Begin Patch
*** Replace in: path/to/file.ts
*** Find:
old text block
*** With:
new text block
*** End Patch
```

You can include multiple `*** Find:` / `*** With:` pairs under one `*** Replace in:` block.

---

## Standard mode: Add / Update / Delete

```text
*** Begin Patch
*** Add File: path/to/new.txt
+new content
*** Update File: path/to/existing.ts
 context line
-old line
+new line
*** Delete File: path/to/old.txt
*** End Patch
```

For multiple edits in the same file, use **one** `*** Update File:` block with multiple `@@` hunks.

---

## Rules that prevent failures

1. Patch must start with `*** Begin Patch` and end with `*** End Patch`.
2. Paths must be relative to project root.
3. In `Update File`, `-` lines must match file content exactly.
4. Include real context lines (prefix with a single space ` `).
5. `@@` lines are only hints; they do not replace real context.
6. Do not make separate `apply_patch` calls for the same file in one task.

---

## Matching behavior

- `fuzzyMatch` defaults to `true` (helps with small whitespace differences).
- Set `fuzzyMatch: false` for strict matching.
- If a hunk may be stale, set `allowRejects: true` to apply valid parts and skip invalid ones.

---

## Common errors

- **Missing end marker** → add `*** End Patch`.
- **Failed to find expected lines** → re-read the file and rebuild patch with exact context.
- **Ambiguous update** → provide longer context or use `*** Replace in:` mode.

---

## Minimal templates

### Update one line
```text
*** Begin Patch
*** Update File: src/app.ts
 function main() {
-  console.log("old");
+  console.log("new");
 }
*** End Patch
```

### Add file
```text
*** Begin Patch
*** Add File: src/new.ts
+export const ok = true;
*** End Patch
```

### Delete file
```text
*** Begin Patch
*** Delete File: src/obsolete.ts
*** End Patch
```
